{% load static %}
<!DOCTYPE html>
<html lang="en">

<head>

    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <meta name="description" content="">
    <meta name="author" content="">

    <title>Tergum - Professional Translation Service</title>

    <!-- Custom fonts for this template-->
    <link href="{% static 'administrator/js/vendor/fontawesome-free/css/all.min.css' %}" rel="stylesheet" type="text/css">
    <link
        href="https://fonts.googleapis.com/css?family=Nunito:200,200i,300,300i,400,400i,600,600i,700,700i,800,800i,900,900i"
        rel="stylesheet">
        <meta name="viewport" content="width=device-width, initial-scale=1"><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/normalize/5.0.0/normalize.min.css">
        <script src="https://ajax.googleapis.com/ajax/libs/jquery/2.1.1/jquery.min.js"></script>
<script src="https://cdn.rawgit.com/harvesthq/chosen/gh-pages/chosen.jquery.min.js"></script>
<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>
<script src='https://cdnjs.cloudflare.com/ajax/libs/jquery/2.1.3/jquery.min.js'></script>

<link href="{% static 'administrator/css/active_job_details.css' %}" rel="stylesheet">
    <link href="{% static 'administrator/css/style.css' %}" rel="stylesheet">
    <link href="{% static 'administrator/css/admin_dashboard.css' %}" rel="stylesheet">
<style>

.pay-btn {
      background: rgb(14, 14, 14);
      color: #fff;
      width: 100%;
      border-radius: 6px;
      border: 2px solid;
      border-color:  rgb(5, 5, 5);
      padding: 8px 18px;
      outline: none;
      }
     .job-btn {
  background:#009970;
  color: #fff;
  border-radius: 10px;
  text-align: right;
  margin: 0 10px;
  border: none;
  padding: 10px 12px;
  }
  .quality-btn {
        background: #fff;
        color:#DAA520;
        border-radius: 6px;
        margin: 0 2px;
        border: 2px solid;
        border-color: #DAA520;
        padding: 8px 8px;
        outline: 0;
        }
        
  
  .assignto-btn {
  background:black;
  color: #fff;
  border-radius: 10px;
  text-align: right;
  margin: 0 5px;
  border: none;
  padding: 11px 20px;
  }


  .scroll {
    overflow-y: scroll;
    scroll-behavior: smooth;
    height: 350px;
    width: 100%;
    overflow-x: hidden;
}

::-webkit-scrollbar {
    width: 10px
}

::-webkit-scrollbar-track {
    background: #eee
}

::-webkit-scrollbar-thumb {
    background: #888
}

::-webkit-scrollbar-thumb:hover {
    background: #555
}
.due-btn {
      background: rgb(218, 63, 63);
      color: #fff;
      border-radius: 6px;
      border: 2px solid;
      border-color:  rgb(218, 63, 63);
      padding: 8px 18px;
      outline: none;
      }

      .paid-btn {
      background: #009970;
      color: #fff;
      border-radius: 6px;
      border: 2px solid;
      border-color:  #009970;
      padding: 8px 18px;
      outline: none;
      }

      .processing-btn {
      background: #DAA520;
      color: #fff;
      border-radius: 6px;
      border: 2px solid;
      border-color:  #DAA520;
      padding: 8px 18px;
      outline: none;
      }
      .category-btn {
		background: #009970;
		color: #fff;
		border-radius: 10px;
		text-align: right;
		border: none;
		padding: 8px 25px;
	}
	
	::-webkit-scrollbar {
		width: 10px
	}
	
	::-webkit-scrollbar-track {
		background: #eee
	}
	
	::-webkit-scrollbar-thumb {
		background: #888
	}
	
	::-webkit-scrollbar-thumb:hover {
		background: #555
	}
	
	.main {
		background-color: #eee;
		width: 100%;
		position: relative;
		border-radius: 8px;
		box-shadow: 0 4px 4px 0 rgba(0, 0, 0, 0.2), 0 4px 4px 0 rgba(0, 0, 0, 0.19);
		padding: 6px 0px 0px 0px
	}
	
	.scroll {
		overflow-y: scroll;
		scroll-behavior: smooth;
		height: 250px;
	}
	
	.img1 {
		border-radius: 50%;
		background-color: #66BB6A
	}
	
	.name {
		font-size: 8px
	}
	
	.msg {
		background-color: #fff;
		font-size: 11px;
		padding: 5px;
		border-radius: 5px;
		font-weight: 500;
		color: #3e3c3c
	}
	
	.between {
		font-size: 8px;
		font-weight: 500;
		color: #a09e9e
	}
	
	.navbar {
		border-bottom-left-radius: 8px;
		border-bottom-right-radius: 8px;
	}
	
	.form-control {
		font-size: 12px;
		font-weight: 400;
		width: 80%;
		height: 33px;
		border: none
	}
	
	form-control: focus {
		box-shadow: none;
		overflow: hidden;
		border: none
	}
	
	.btn-tertiary {
		color: #555;
		line-height: 40px;
		display: block;
		border: 2px solid #555;
		margin-top: 0.25em;
		margin-bottom: 0;
		padding: 10px 0px;
	}
	
	.btn-tertiary:hover,
	.btn-tertiary:focus {
		color: #888888;
		border-color: #888888;
	}
</style>

</head>


<body id="page-top">

    <!-- Page Wrapper -->
    <div id="wrapper">
   {% if request.user.is_staff %}
        
        {% include 'administrator/sidebar.html' %}
        {% endif %}


        <!-- Content Wrapper -->
        <div id="content-wrapper" class="d-flex flex-column">

            <!-- Main Content -->
            <div id="content">
<!-- Topbar -->
{% include 'base/navbar.html' %}
<!-- End of Topbar -->

                <!-- Begin Page Content -->
                <div class="container-fluid my-2 mx-2">

                    <!-- Content Row -->
                    <div class="section-title" data-aos="fade-right">
                        <div class="col">
                            <h2>Jobs#{{job_obj.job_id}}</h2>
                        </div>
                            {% if request.user.is_superuser %}
                            <div class="col text-right pull right my-2">
                              <button class="assignto-btn" style="cursor: pointer;color:white;" onclick="location.href = '/admin/jobs/details/{{job_obj.job_id}}';">Assign Contracts</button>
                          </div>
                      {% endif %}
                    </div>

<div class="row">
    <!--job details-->
    <div class="col-lg-6 mb-3 ">
        <div class="card border-left-success shadow h-100 pb-0">
           <div class="card-body pb-1">
              <div class="heading">
                 <h4 class="text-wrap text-break mx-2">Job details</h4>
                 <span>Job#{{job_obj.job_id}}</span>
                 <input type="hidden" id="job_id" name="job_id" value="{{job_obj.job_id}}"> 
                 <input type="hidden" id="staff_user" name="staff_user" value="{{request.user.is_staff}}"> 

              </div>
              <div class="row">
                 <div class="col">
                    <div class="row ml-2">
                       <span>Created on {{job_obj.posted_date  | date:"d F,  Y"}}</span>
                    </div>
                 </div>
                 <div class="col text-right pull-right px-4 my-auto">
                    <h2>${{job_obj.calculate_total_price | floatformat:2}}</h2>
                 </div>
              </div>
              <div class="row my-2">
                 <div class="col-lg-6 my-2">
                    <div class="language-btn my-3" style="text-align: center;"><strong>Source- {{job_obj.source_language}} </strong></div>
                    <div class="quality-btn"  style="text-align: center;"><strong>{{job_obj.quality}}</strong></div>
                 </div>
                 <div class="col-lg-6 my-2">
                    <div class="language-btn my-3" style="text-align: center;"><strong>To- {{job_obj.targetLanguageToString}}</strong></div>
                    <div class="type-btn"  style="text-align: center;"><strong>{{job_obj.content}}</strong></div>
                 </div>
              </div>
           </div>
        </div>
     </div>
    <!--end job details-->
    <!--chatbox-->
    <div class="col-lg-6 mb-3">
        <div class="main">
            <div class="justify-content-end align-content-right text-right mr-2"><i id="chat_refresh" class="fas fa-redo"></i></button> </div>

            <div id="chat" class="px-2 scroll">
    
           
            </div>
            <br>
            <nav class="navbar bg-white navbar-expand-sm d-flex justify-content-between">
                <input type="text number" name="text" id="message" class="form-control" placeholder="Type a message...">

                <div class="justify-content-end align-content-center text-center"><button class="type-btn" id="send">Send</button> </div>

            </nav>
        </div>
    </div>
        <!--end chatbox-->
</div>
<!--translation and proofreading pending-->

               <div class="row">
                  {% for contract in contracts%}

                <div class= "col-lg-6 my-2">
                   <div class="card border-left-success shadow h-100 py-0">
                      <div class="card-body">
                       

                         <div class="heading">
                           <div class="col">
                            <h3>Contract#{{contract.contract_id}}</h3>   
                          </div>
                        

                          {% if contract.completed and contract.final %}

                          <div class="col-auto my-auto ">
                             <a id="{{contract.contract_id}}"> <i class="fas fa-download fa-2x text-gray-300"></i></a>
                          </div>
                          {% endif %}

                         </div>



                         
                         <div class="row">
                            <div class="col">
                              <div class="row ml-1">
                                 <p>Created on {{contract.job.posted_date | date:"d F, Y"}}</p>
                              </div>

                              {% if contract.is_signed %}
                                 <div class="row ml-1">
                                    <p>Signed on {{contract.signing_date | date:"d F, Y"}} by <a href = "/admin/translator/{{contract.profile.username}}/details" >{{contract.profile.username}}</a></p>
                                 </div>
                              {% else %}
                              <div class="row ml-1">
                                 <p>Not signed yet</p>
                              </div>
                              {% endif %}
                              

                            </div>
                         
                         </div>
                         <div class="row mt-2">

                            <div class="col-lg-6 mb-2">
                                <div class="language-btn" style="text-align: center;"><strong>{{contract.job.source_language}} -> {{contract.target_language}}</strong></div>
                                 {% if contract.completed %}
                                 {% if contract.final %}
                                 {% if contract.rating > 0 %}
                                 
                                 {% if not request.user.is_superuser %}
                                 <button class="paid-btn my-3"  style="text-align: center; width: 100%;" style="cursor: pointer;" onclick="location.href = '/contract/feedback/{{contract.contract_id}}';" ><strong>{{contract.rating}} Stars</strong></button>
                                 {% else %}
                                 <button class="paid-btn my-3"  style="text-align: center; width: 100%;" style="cursor: context-menu;"  ><strong>{{contract.rating}} Stars</strong></button>
                                 {% endif %}

                                    {% else %}
                                 {% if not request.user.is_superuser %}
                                    <button class="type-btn my-3"  style="text-align: center; width: 100%;" style="cursor: pointer;" onclick="location.href = '/contract/feedback/{{contract.contract_id}}';" ><strong>Provide Feedback</strong></button>
                                    {% else %}
                                    <button class="paid-btn my-3"  style="text-align: center; width: 100%;" style="cursor: context-menu;"  ><strong>Awaiting Feedback</strong></button>
                                    {% endif %}

                                {% endif %}

                                    {% else %}
                                    <button class="type-btn my-3"  style="text-align: center; width: 100%;" disabled><strong>view feedback</strong></button>

                                    {% endif %}
                                
                                {% endif %}
                           
                              </div>
                            
                             <div class="col-lg-6">
                       
                                 <div class="quality-btn" style="text-align: center;"><strong>{{contract.status_verbose }}</strong></div>
                                 {% if  contract.completed %}
                                <button class="paid-btn mt-3"  style="text-align: center;width: 100%;" ><strong>Done &nbsp;<i class="fas fa-check"></i></strong></button>
                                    
                                 {% endif %}

                                 </div>
                              </div>
                           
                              {% if not contract.completed %}

                         <div class="row ">
                           <div class="col-lg-12">

                                    {% if contract.is_signed %}

                                    <button class="processing-btn my-3"  style="text-align: center;width: 100%;"><strong>Processing</strong></button>
                                    
                                    {% else %}
                                    <button class="due-btn mt-3"  style="text-align: center;width: 100%;"><strong>Pending</strong></button>
                                   
                                    {% endif %}

                                 </div>
                       
                             </div>
                             {% endif %}


                           </div>
                     
                      
               
                </div>
          
             </div>
       
             {% endfor %}


      
   </div>


<!--close row-->

                 

</div>
 <!-- /.container-fluid -->

            </div>
            <!-- End of Main Content -->

            <!-- Footer -->
            <footer class="sticky-footer">
                <div class="container my-auto">
                    <div class="copyright text-center my-auto">
                        <span>Copyright &copy; Tergum 2020</span>
                    </div>
                </div>
            </footer>
            <!-- End of Footer -->

        </div>
        <!-- End of Content Wrapper -->

    </div>
    <!-- End of Page Wrapper -->

    <!-- Scroll to Top Button-->
    <a class="scroll-to-top rounded" href="#page-top">
        <i class="fas fa-angle-up"></i>
    </a>

    <!-- Bootstrap core JavaScript-->
    <script src="{% static 'administrator/js/vendor/jquery/jquery.min.js' %}"></script>
    <script src="{% static 'administrator/js/vendor/bootstrap/js/bootstrap.bundle.min.js' %}"></script>

    <!-- Core plugin JavaScript-->
    <script src="{% static 'administrator/js/vendor/jquery-easing/jquery.easing.min.js' %}"></script>

    <!-- Custom scripts for all pages-->
    <script src="{% static 'administrator/js/sb-admin-2.min.js' %}"></script>


    <!-- Page level custom scripts -->
    <script src='https://cdnjs.cloudflare.com/ajax/libs/jquery/2.2.2/jquery.min.js'></script>
     <script src='https://harvesthq.github.io/chosen/chosen.jquery.js'></script>

     <script src="https://code.jquery.com/jquery-3.2.1.slim.min.js" integrity="sha384-KJ3o2DKtIkvYIK3UENzmM7KCkRr/rE9/Qpg6aAZGJwFDMVNA/GpGFF93hXpG5KkN" crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.12.9/umd/popper.min.js" integrity="sha384-ApNbgh9B+Y1QKtv3Rn7W3mgPxhU9K/ScQsAP7hUibX39j7fakFPskvXusvfa0b4Q" crossorigin="anonymous"></script>

<script type="text/javascript" src="{% static 'administrator/js/FileSaver.min.js' %}"></script>

<script src="{% static 'administrator/js/jszip/dist/jszip.min.js' %}" type="text/javascript"></script>
<script type="text/javascript" src="{% static 'administrator/js/jszip-utils/dist/jszip-utils.js' %}"></script>


{% for contract in contracts%}
{% if contract.completed and contract.final %}

<script>
    $('#{{contract.contract_id}}').click(function(e) {

var urls = [
{% for submission in contract.submissions.all %}
'{{submission.submission_file.url}}',
{% endfor %}
               ];
var nombre = "{{contract.job.source_language}}to{{contract.target_language}}";
//The function is called
compressed_img(urls,nombre);

function compressed_img(urls,nombre) {
  var zip = new JSZip();
  var count = 0;
  var name = nombre+".zip";
  urls.forEach(function(url){
    JSZipUtils.getBinaryContent(url, function (err, data) {
      if(err) {
         throw err; 
      }
       url = url.split("/")[url.split("/").length -1] 
       zip.file(url, data,  {binary:true});
       count++;
       if (count == urls.length) {
         zip.generateAsync({type:'blob'}).then(function(content) {
            saveAs(content, name);
         });
       }
      });
  });
}
});

</script>
{% endif %}
{% endfor %}
<script src="https://code.jquery.com/jquery-3.1.1.min.js"></script>



<script>
    function append_messages(data)
            {
                    var is_staff = $("#staff_user").val()
					//alert(is_staff);
                        if(is_staff  == "True"){
							for (i = 0; i < data.length; i++) {

                            if(data[i]["employee"] ){
                            $("#chat").append('<div class="d-flex align-items-center text-right justify-content-end "><div class="pr-2"> <span class="name" id="username">'+data[i]["username"]+'</span><p class="msg">'+data[i]["text"]+'</p></div><div></div></div>')
                            }
                            else{
                            $("#chat").append('<div class="d-flex align-items-center"><div class="text-left pr-1"></div><div class="pr-2 pl-1"> <span class="name">'+data[i]["username"]+'</span><p class="msg">'+data[i]["text"]+'</p></div></div>')
                            }
                        }
					}
                        else{

							for (i = 0; i < data.length; i++) {

                            if(data[i]["employee"] == false){
                            $("#chat").append('<div class="d-flex align-items-center text-right justify-content-end "><div class="pr-2"> <span class="name" id="username">'+data[i]["username"]+'</span><p class="msg">'+data[i]["text"]+'</p></div><div></div></div>')
                            }
                            else{
                            $("#chat").append('<div class="d-flex align-items-center"><div class="text-left pr-1"></div><div class="pr-2 pl-1"> <span class="name">'+data[i]["username"]+'</span><p class="msg">'+data[i]["text"]+'</p></div></div>')
                            }
                        }
					}
                        
                        
                        var newmsg_top = parseInt($('#chat')[0].scrollHeight );
                        $('#chat').scrollTop(newmsg_top);
                    }
</script>


<script>

function refresh_chat(){
    $.ajax({
            type: 'POST',
            url: "/en/api/jobs/chat/get/",
            data: {
                job_id: $('#job_id').val(),
                action: 'post'
            },
    
            success: function(data, textStatus, xhr) {
                $("#message").attr("placeholder", "Type a message...");
                
                if (xhr.status == 200) {
                    $('#send').prop('disabled', false);
                    $("#send").html('<small>' + data.error + '</small>');
                    setTimeout(function() {
                        $("#send").html('Send');
                    }, 2000);
                } else if (xhr.status == 202) {
                    $("#chat").empty()
                    $('#message').val('');
                    $('#send').prop('disabled', false);
                    $("#send").html('Send');
                    append_messages(data);
                }
    
    
            },
            error: function(xhr, errmsg, err) {
                $("#message").attr("placeholder", "Failed to load the chat, please refresh.");

                $("#send").html('<small>Failed! Please refresh.</small>');
                
            },
        });
}

</script>
<script>
$( document ).ready(function() {
    $('#send').prop('disabled', true);
    $("#send").html('<div class="spinner-border" style="width: 1.25rem; height: 1.25rem;" role="status"></div>');
    $("#message").attr("placeholder", "Chat is loading...");
    refresh_chat();
});
</script>

<script>
    $('#chat_refresh').click(function(e) {
        $('#send').prop('disabled', true);
        $("#send").html('<div class="spinner-border" style="width: 1.25rem; height: 1.25rem;" role="status"></div>');
        $("#message").attr("placeholder", "Looking for new messages...");
        refresh_chat();
    });
</script>

<script>
     
    $('#send').click(function(e) {
        e.preventDefault();
        $('#send').prop('disabled', true);
        $("#send").html('<div class="spinner-border" style="width: 1.25rem; height: 1.25rem;" role="status"></div>');
        $.ajax({
            type: 'POST',
            url: "/en/api/jobs/chat/send/",
            data: {
                job_id: $('#job_id').val(),
                message: $('#message').val(),
                action: 'post'
            },
    
    
    
            success: function(data, textStatus, xhr) {
               console.log(data);
                if (xhr.status == 200) {
                    $('#send').prop('disabled', false);
                    $("#send").html('<small>' + data.error + '</small>');
                    setTimeout(function() {
                        $("#send").html('Send');
                    }, 2000);
                } else if (xhr.status == 202) {
                    $("#chat").empty()
                    $('#message').val('');
                    $('#send').prop('disabled', false);
                    $("#send").html('Send');
                    append_messages(data);
                }
    
    
            },
            error: function(xhr, errmsg, err) {
                $('#send').prop('disabled', false);
                $("#send").html('<small>Failed! try again later</small>');
                setTimeout(function() {
                    $("#send").html('Send');
                }, 2000);
            },
    
    
    
        });
    });
          </script>

</body>
</html>